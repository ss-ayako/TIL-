PHPでファイルをzipにまとめて一括ダウンロード  
```
// Zipクラスロード
$zip = new ZipArchive();
// Zipファイル名
$zipFileName = "file_" . date("Ymds") .'.zip';
// Zipファイル一時保存ディレクトリ
$zipTmpDir = '/tmp/zip/';
```
- コードの流れについておさらい

### 1. ユーザーがダウンロードボタンをクリック

* ブラウザがサーバーにリクエストを送信します。
* リクエストには、どのファイルをダウンロードしたいかなどの情報が含まれています。

### 2. サーバー側でPHPスクリプトが実行

1. **ZIPライブラリの読み込み:**
   * PHPには標準でZIPを扱う機能はありません。ZipArchiveクラスなどのライブラリを組み込みます。
2. **ZIPアーカイブの作成:**
   * ZipArchiveクラスのインスタンスを作成し、新しいZIPアーカイブを作成します。
   * 複数のファイルやフォルダを1つのファイルにまとめて圧縮し、その圧縮されたファイルを「ZIPアーカイブ」と呼ぶ
3. **ファイルの追加:**
   * ダウンロードしたい動画ファイルのパスを指定し、ZIPアーカイブに追加していきます。
4. **ZIPアーカイブの保存:**
   * 作成したZIPアーカイブをサーバー上の任意の場所に保存します。
5. **ダウンロード処理:**
   * ヘッダー情報を設定し、ブラウザにZIPファイルをダウンロードさせるように指示します。

### 3. ブラウザでのダウンロード

* サーバーから送られてきたZIPファイルの情報を元に、ブラウザがダウンロード処理を開始します。
* ユーザーが指定した場所にZIPファイルが保存されます。

### コードの例 (簡易版)

```php
<?php
// ダウンロードするファイルのパスを配列に格納
$files = ['video1.mp4', 'video2.mp4', 'video3.mp4'];

// ZipArchiveクラスのインスタンスを作成
$zip = new ZipArchive();

// 一時的に保存するZIPファイル名
$zip_filename = 'videos.zip';

// ZIPアーカイブを作成
if ($zip->open($zip_filename, ZipArchive::CREATE) === TRUE) {
    foreach ($files as $file) {
        $zip->addFile($file, basename($file)); // ファイルを追加
    }
    $zip->close();

    // ダウンロード処理
    header('Content-Description: File Transfer');
    header('Content-Type: application/zip');
    header('Content-Disposition: attachment; filename=' . $zip_filename);
    header('Content-Length: ' . filesize($zip_filename));
    readfile($zip_filename);

    // 一時ファイルの削除（任意）
    unlink($zip_filename);
} else {
    echo 'ZIPアーカイブの作成に失敗しました。';
}
?>
```

### コード解説

* **ZipArchiveクラス:** PHPの標準ライブラリに含まれるZipArchiveクラスを使用することで、簡単にZIPファイルを作成できます。
* **addFileメソッド:** ZIPアーカイブにファイルを追加するメソッドです。
* **header関数:** HTTPヘッダーを設定し、ブラウザにファイルの情報を伝えます。
* **readfile関数:** ファイルの内容をブラウザに直接出力します。

### 注意点

* **セキュリティ:**
  - ダウンロードするファイルのパスを外部から直接入力させないように注意が必要です。
  - サーバーのセキュリティ設定も適切に行い、不正アクセスを防ぎましょう。
* **パフォーマンス:**
  * 大量のファイルをZIPに圧縮する場合、処理時間がかかることがあります。
  * サーバーの負荷に注意し、必要であれば非同期処理などを検討しましょう。
* **エラー処理:**
  * ZIPアーカイブの作成に失敗した場合など、エラーが発生する可能性も考慮し、適切なエラー処理を行いましょう。
***

### ZIPファイルの作成を「荷物の梱包」に例えてみる  

あなたは、複数のプレゼントを友達に送りたいとします。  
それぞれのプレゼントを個別に包んで送るのも良いですが、  
まとめて一つの箱に詰めれば、送料も安く、持ち運びも楽になりますよね。  
この箱に詰める作業が、まさに**ZIPファイルの作成**に当たります。  

* **プレゼント:** ダウンロードしたい動画ファイル  
* **箱:** ZIPファイル  
* **箱に詰める:** ファイルをZIPファイルに追加する  
* **送料を安くする:** ファイルサイズを圧縮して、ダウンロード時間を短縮する  

### ダウンロード処理を「宅配便の発送」に例えてみる  

**今度は、梱包した箱（ZIPファイル）を友達に送る場面を想像してみましょう。**  

* **宅配便会社に依頼:** ウェブサーバーが、ダウンロードのリクエストを受け付け、ZIPファイルを準備します。  
* **送り状を貼る:** ZIPファイルに、宛先（ブラウザ）や内容（ファイル名など）を示す情報（HTTPヘッダー）を付与します。  
* **宅配便のトラックに乗せる:** 準備したZIPファイルを、インターネットという道路を通って、友達（ブラウザ）のところへ送ります。  
* **友達が受け取る:** ブラウザがZIPファイルを受け取り、指定された場所に保存します。

### PHPのコードとの対応

* **ZipArchiveクラス:** 梱包用の箱を作るための道具箱
* **addFileメソッド:** プレゼントを箱に詰める作業
* **header関数:** 送り状を貼る作業
* **readfile関数:** 宅配便のトラックに乗せる作業
***
***
